<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - Scholarship Pool</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background-color: #007bff;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin-left: 1.5rem;
      font-weight: 600;
      transition: color 0.3s ease;
    }
    nav a:hover {
      color: #cce5ff;
    }

    main {
      flex: 1;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 95vw;
      overflow-x: auto;
    }

    h2 {
      color: #333;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,123,255,0.12);
    }
    thead {
      background-color: #007bff;
      color: white;
    }
    thead th {
      padding: 1rem;
      text-align: left;
      font-weight: 700;
      font-size: 1rem;
    }
    tbody td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
      color: #444;
      vertical-align: middle;
    }
    tbody tr:hover {
      background-color: #f1f8ff;
    }

    button.approve, button.decline {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      color: white;
      font-size: 0.9rem;
      margin-right: 0.4rem;
      transition: background-color 0.3s ease;
    }
    button.approve {
      background-color: #28a745;
      box-shadow: 0 4px 12px rgba(40,167,69,0.3);
    }
    button.approve:hover {
      background-color: #19692c;
    }
    button.decline {
      background-color: #dc3545;
      box-shadow: 0 4px 12px rgba(220,53,69,0.3);
    }
    button.decline:hover {
      background-color: #a71d2a;
    }

    #adminMessage {
      margin: 1rem 0;
      font-weight: 600;
      min-height: 1.2em;
      color: red;
    }

    button#adminLogoutBtn {
      margin-top: 1.5rem;
      background: #dc3545;
      border: none;
      color: white;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 6px 16px rgba(220,53,69,0.3);
      transition: background-color 0.3s ease;
      font-size: 1rem;
    }
    button#adminLogoutBtn:hover {
      background: #a71d2a;
    }

    /* Modal Styles */
    #docModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #docModalContent {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      max-width: 90vw;
      max-height: 90vh;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }
    #docModal iframe, #docModal img {
      max-width: 100%;
      max-height: 80vh;
      border: none;
      margin-top: 1rem;
      border-radius: 6px;
    }
    #docModalClose {
      align-self: flex-end;
      background: #dc3545;
      border: none;
      color: white;
      font-weight: 700;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    #docModalClose:hover {
      background: #a71d2a;
    }
  </style>
</head>
<body>
  <header>
    <h1>Scholarship Pool</h1>
    <nav>
      <a href="admin-dashboard.html">Dashboard</a>
      <a href="index.html">Home</a>
      <a href="user-login.html">User Login</a>
      <a href="admin-login.html">Admin Login</a>
    </nav>
  </header>

  <main>
    <h2>Manage Scholarship Applications</h2>
    <p id="adminMessage"></p>
    <table id="applicationsTable" aria-label="Scholarship applications">
      <thead>
        <tr>
          <th>ID</th>
          <th>Full Name</th>
          <th>University</th>
          <th>Course</th>
          <th>Achievement</th>
          <th>Graduation Date</th>
          <th>Wallet</th>
          <th>Amount (ETH)</th>
          <th>Document</th> <!-- NEW COLUMN -->
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filled dynamically -->
      </tbody>
    </table>

    <button id="adminLogoutBtn">Logout</button>
  </main>

  <!-- Document Preview Modal -->
  <div id="docModal">
    <div id="docModalContent">
      <button id="docModalClose">Close</button>
      <!-- We'll inject iframe or img here -->
      <div id="docViewerContainer"></div>
    </div>
  </div>

  <footer>
    &copy; 2025 Scholarship Pool. All rights reserved.
  </footer>

  <script>
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const adminMessage = document.getElementById('adminMessage');
    const tableBody = document.querySelector('#applicationsTable tbody');

    // Modal elements
    const docModal = document.getElementById('docModal');
    const docModalClose = document.getElementById('docModalClose');
    const docViewerContainer = document.getElementById('docViewerContainer');

    // Example check for admin login session (replace with real session logic)
    const isAdminLoggedIn = true; // TODO: Replace with real session check

    if (!isAdminLoggedIn) {
      alert('Please login as admin first.');
      window.location.href = 'admin-login.html';
    }

    async function fetchApplications() {
      try {
        const res = await fetch('/api/admin/applications');
        if (!res.ok) throw new Error('Failed to fetch applications');
        const applications = await res.json();

        tableBody.innerHTML = ''; // Clear table

        applications.forEach(app => {
          const tr = document.createElement('tr');

          // Safely encode data to prevent XSS if needed (simple here)
          const safe = (str) => String(str).replace(/</g, "&lt;").replace(/>/g, "&gt;");

          // Build document link HTML
          const docLinkHtml = app.documentUrl
            ? `<a href="#" onclick="openDocument('${app.documentUrl}'); return false;">View Document</a>`
            : 'N/A';

          tr.innerHTML = `
            <td>${app.id}</td>
            <td>${safe(app.fullName)}</td>
            <td>${safe(app.universityName)}</td>
            <td>${safe(app.courseName)}</td>
            <td>${safe(app.achievement)}</td>
            <td>${safe(app.expectedGraduationDate)}</td>
            <td style="word-break: break-all;">${safe(app.wallet)}</td>
            <td>${app.amount}</td>
            <td>${docLinkHtml}</td>
            <td>${safe(app.status)}</td>
            <td>
              ${app.status === 'Pending' ? `
                <button class="approve" data-id="${app.id}">Approve</button>
                <button class="decline" data-id="${app.id}">Decline</button>
              ` : '-'}
            </td>
          `;
          tableBody.appendChild(tr);
        });

        // Attach event listeners to buttons
        document.querySelectorAll('button.approve').forEach(btn => {
          btn.addEventListener('click', () => handleAction(btn.dataset.id, 'approve'));
        });
        document.querySelectorAll('button.decline').forEach(btn => {
          btn.addEventListener('click', () => handleAction(btn.dataset.id, 'decline'));
        });
      } catch (err) {
        adminMessage.style.color = 'red';
        adminMessage.textContent = err.message;
      }
    }

    async function handleAction(applicationId, action) {
      adminMessage.style.color = 'black';
      adminMessage.textContent = `${action === 'approve' ? 'Approving' : 'Declining'} application #${applicationId}...`;

      try {
        const res = await fetch(`/api/admin/application/${applicationId}/${action}`, {
          method: 'POST'
        });
        if (!res.ok) throw new Error(`Failed to ${action} application`);

        adminMessage.style.color = 'green';
        adminMessage.textContent = `Application #${applicationId} ${action}d successfully.`;

        fetchApplications();
      } catch (err) {
        adminMessage.style.color = 'red';
        adminMessage.textContent = err.message;
      }
    }

    adminLogoutBtn.onclick = () => {
      // clear admin session (implement your own logic)
      alert('Logged out');
      window.location.href = 'index.html';
    };

    // Modal open function
    function openDocument(url) {
      // Clear previous content
      docViewerContainer.innerHTML = '';

      // Check file extension for preview type
      const extension = url.split('.').pop().toLowerCase();

      if (extension === 'pdf') {
        // Use iframe for PDF
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.style.width = '100%';
        iframe.style.height = '80vh';
        docViewerContainer.appendChild(iframe);
      } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension)) {
        // Use img tag for images
        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Document Image';
        docViewerContainer.appendChild(img);
      } else {
        docViewerContainer.innerHTML = `<p>Cannot preview this document type. <a href="${url}" target="_blank" rel="noopener">Open in new tab</a></p>`;
      }

      docModal.style.display = 'flex';
    }

    // Modal close event
    docModalClose.onclick = () => {
      docModal.style.display = 'none';
      docViewerContainer.innerHTML = '';
    };

    // Close modal when clicking outside content
    docModal.addEventListener('click', e => {
      if (e.target === docModal) {
        docModal.style.display = 'none';
        docViewerContainer.innerHTML = '';
      }
    });

    fetchApplications();
  </script>
</body>
</html>
